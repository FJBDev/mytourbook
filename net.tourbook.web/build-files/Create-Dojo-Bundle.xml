<?xml version='1.0' encoding='UTF-8'?>
<project name="CreateDojoFiles" default="all" basedir=".">
	
	<property name="dojoToolkitFolder"				value="C:/E/js-resources/dojo/MyTourbook-DojoToolkit" />
	
	<property name="rootFolderDev"					value="../WebContent-dev" />
	<property name="rootFolderRel"					value="../WebContent-rel" />

	<property name="srcFolderDev"					value="${rootFolderDev}/tourbook" />
	<property name="srcFolderRel"					value="${rootFolderRel}/tourbook" />
	
	<property name="tourbookBasePath"				value="${dojoToolkitFolder}" />
	<property name="tourbookInDojoToolkitFolder"	value="${tourbookBasePath}/tourbook" />
	
	<property name="dojoBuildFolder"				value="../../../../mytourbook-BUILD-dojo" />
	<property name="releaseFolder"					value="${dojoBuildFolder}/mt-dojo-release" />

	<target name="all" depends="cleanBuild,cleanMTRelease,shrink,compress,copyResources" />

	<target name="cleanBuild">
		<echo level="info" message="Clean build folder" />
		<delete dir="${tourbookInDojoToolkitFolder}" />
		<delete includeEmptyDirs="true">
			<fileset dir="${dojoBuildFolder}" includes="**/*" defaultexcludes="no"/>
		</delete>
	</target>

	<target name="cleanMTRelease">
		<echo level="info" message="Clean MT release folder" />
		<delete dir="${srcFolderRel}" />
	</target>

	<target name="shrink">

		<echo level="info" message="Copying src files into dojo root ..." />
		<copy todir="${tourbookInDojoToolkitFolder}" preservelastmodified="yes" verbose="no">
			<fileset dir="${srcFolderDev}">
				<include name="**/*" />
			</fileset>
		</copy>


		<echo level="info" message="Running dojo custom build..." />
		<java dir="${dojoToolkitFolder}/util/buildscripts" 
			fork="true" 
			classname="org.mozilla.javascript.tools.shell.Main" 
			failonerror="true">
			
			<classpath path="${dojoToolkitFolder}/util/shrinksafe/js.jar;${dojoToolkitFolder}/util/closureCompiler/compiler.jar;${dojoToolkitFolder}/util/shrinksafe/shrinksafe.jar" />

			<arg line="${dojoToolkitFolder}/dojo/dojo.js " />

			<!-- dojo root -->
			<arg value="baseUrl=${dojoToolkitFolder}/dojo" />
			
			<!-- tourbook source -->
			<arg value="basePath=${tourbookBasePath}" />
			
			<!-- release folder -->
			<arg value="releaseDir=${releaseFolder}" />
			
			<!-- major profile -->
			<arg value="profile=${basedir}/mytourbook-app.profile.js" />
			
			<!-- "action" options
				release
			    check                   print computed profile, then terminate
			    // vvvvv is valid ONLY in the arg line
		    	check-args              print computed raw command line input, including raw profiles, then terminate
			    check-discovery         print all discovered resources, then terminate
			    debug-check             print computed profile, including internal structures -->
			<arg value="action=release" />

			<arg value="load=build" />
		</java>

	</target>
	
	<target name="compress">
		
		<copy todir="${srcFolderRel}" preservelastmodified="no" verbose="yes">
			<fileset dir="${srcFolderDev}">
				<include name="**/*"/>
				<exclude name="**/*.js"/>
				<exclude name="**/search.css"/> <!-- this file is in the build layer -->
			</fileset>
		</copy>
		
		<copy todir="${rootFolderRel}/tourbook/search/nls" preservelastmodified="no" verbose="yes">
			<fileset dir="${releaseFolder}/tourbook/search/nls">
				<include name="**/*.js"/>
				<exclude name="**/*uncompressed*"/>
			</fileset>
		</copy>

		<!--compress minimized files and create it in the src folder -->
		<mkdir dir="${rootFolderRel}/dojo"/>	
		<gzip  	src="${releaseFolder}/dojo/dojo.js" 
				destfile="${rootFolderRel}/dojo/dojo.js.jgz"/>
		
		<gzip  	src="${releaseFolder}/tourbook/search/SearchApp.js" 
				destfile="${srcFolderRel}/search/SearchApp.js.jgz"/>
		
		<gzip  	src="${releaseFolder}/tourbook/search/search.css" 
				destfile="${srcFolderRel}/search/search.css.jgz"/>

	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: copyResources                      
         - - - - - - - - - - - - - - - - - -->
    <target name="copyResources">
            
    	<!--
			copy MT resources
		-->
		<copy todir="${rootFolderRel}" preservelastmodified="no" verbose="yes">
			<fileset dir="${rootFolderDev}">
				<include name="**/favicon.ico"/>
			</fileset>
		</copy>

    	<!--
			copy Dojo resources
		-->
		<copy todir="${rootFolderRel}" preservelastmodified="no" verbose="yes">
			<fileset dir="${dojoToolkitFolder}" id="id">
			    <include name="**/dgrid/css/skins/images/row_back.png"/>
			    <include name="**/dojo/resources/blank.gif"/>
			    <include name="**/dijit/themes/claro/form/images/commonFormArrows.png"/>
			</fileset>
		</copy>
    	
    	<!-- 
    		delete build files
    	-->
		<antcall target="cleanBuild" />

    </target>

</project>
